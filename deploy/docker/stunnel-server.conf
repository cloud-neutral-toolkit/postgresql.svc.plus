; =============================================================================
; stunnel Server Configuration - PostgreSQL TLS Tunnel
; =============================================================================
;
; Architecture:
;   External Client → TLS:443 → stunnel → postgres:5432
;
; Server modes:
;   1. TLS (default)  - One-way TLS, server presents certificate
;   2. mTLS (opt-in)  - Mutual TLS, also requires client certificate
;
; =============================================================================

; Global settings
foreground = yes
debug = 5
; output = /var/log/stunnel/stunnel.log

; -----------------------------------------------------------------------------
; MODE 1: TLS (Default - Server Authentication Only)
; -----------------------------------------------------------------------------
; Clients verify the server certificate via their CA.
; No client certificate required.

[postgres-tls-server]
; Server mode - Accept TLS connections
client = no

; Listen on port 5433 for TLS connections (mapped to host 443)
accept = 0.0.0.0:5433

; Forward to PostgreSQL (internal container network)
connect = postgres:5432

; Server TLS certificate
; Environment variables are substituted by dweomer/stunnel entrypoint
cert = ${STUNNEL_CRT:-/etc/stunnel/certs/server-cert.pem}
key = ${STUNNEL_KEY:-/etc/stunnel/certs/server-key.pem}

; TLS protocol configuration
sslVersion = TLSv1.2
options = NO_SSLv2
options = NO_SSLv3
options = NO_TLSv1
ciphers = ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305

; -----------------------------------------------------------------------------
; MODE 2: mTLS - Mutual TLS (ADVANCED - OPT-IN ONLY)
; -----------------------------------------------------------------------------
; Uncomment to require client certificate authentication.
; Clients must present a valid certificate signed by the CA.
;
; verify = 2
; CAfile = /etc/stunnel/certs/ca-cert.pem

; Performance tuning
socket = l:TCP_NODELAY=1
socket = r:TCP_NODELAY=1
socket = l:SO_KEEPALIVE=1
socket = r:SO_KEEPALIVE=1

; Timeout settings (12 hours idle for long database sessions)
TIMEOUTclose = 0
TIMEOUTidle = 43200

; Process configuration (optional)
; setuid = stunnel
; setgid = stunnel
; pid = /var/run/stunnel/stunnel.pid

; Session cache (optional performance tuning)
; sessionCacheSize = 1000
; sessionCacheTimeout = 300
