; =============================================================================
; stunnel Client Configuration - PostgreSQL TLS Tunnel
; =============================================================================
; 
; Architecture (Sidecar Pattern):
;   Application → localhost:15432 → stunnel → TLS → remote:443
;
; Connection modes:
;   1. TLS (default)       - Server authentication only (CAfile)
;   2. TLS + strict verify - Add verifyChain + checkHost  
;   3. mTLS (advanced)     - Add client cert/key (explicit only)
;
; Usage:
;   psql -h localhost -p 15432 -U postgres -d postgres
;   postgresql://postgres:password@localhost:15432/dbname
;
; =============================================================================

; -----------------------------------------------------------------------------
; MODE 1: TLS (Default - Server Authentication Only)
; -----------------------------------------------------------------------------
; This is the recommended default configuration.
; Server certificates may rotate (e.g. ACME), so trust is based on CA only.

[postgres-client]
client = yes

; Local listen port - Application connects here
accept = 127.0.0.1:15432

; Remote TLS endpoint (stunnel server)
; CHANGE THIS to your actual server address
connect = ${STUNNEL_CONNECT:-db.example.com:443}

; Server certificate verification via CA
; The CA file must contain exactly ONE CA certificate
CAfile = /etc/stunnel/certs/ca-cert.pem
verify = 2

; TLS protocol configuration
sslVersion = TLSv1.2
options = NO_SSLv2
options = NO_SSLv3
options = NO_TLSv1

; Performance tuning
socket = l:TCP_NODELAY=1
socket = r:TCP_NODELAY=1
socket = l:SO_KEEPALIVE=1
socket = r:SO_KEEPALIVE=1

; Connection retry on failure
retry = yes

; Timeout settings (12 hours idle timeout for long sessions)
TIMEOUTclose = 0
TIMEOUTidle = 43200

; -----------------------------------------------------------------------------
; MODE 2: TLS + Strict Verification (OPT-IN)
; -----------------------------------------------------------------------------
; Uncomment the following to enable hostname validation.
; This requires the server certificate CN or SAN to match the hostname.
;
; verifyChain = yes
; checkHost = db.example.com

; -----------------------------------------------------------------------------
; MODE 3: mTLS - Mutual TLS (ADVANCED - EXPLICIT ONLY)
; -----------------------------------------------------------------------------
; DO NOT enable unless explicitly requested and required by the server.
; Uncomment only if the server enforces client certificate authentication.
;
; cert = /etc/stunnel/certs/client-cert.pem
; key = /etc/stunnel/certs/client-key.pem

; -----------------------------------------------------------------------------
; Logging (optional - uncomment for debugging)
; -----------------------------------------------------------------------------
; debug = 5
; output = /var/log/stunnel/stunnel-client.log
