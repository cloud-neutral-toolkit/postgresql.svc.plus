; =============================================================================
; stunnel Client Configuration - PostgreSQL TLS Tunnel
; =============================================================================
; 
; Architecture (Sidecar Pattern):
;   Application → localhost:15432 → stunnel client → TLS → external:443
;
; Connection Scheme: tls://${HOST}:${TLS_PORT}
;
; Connection modes:
;   1. TLS (one-way)       - DEFAULT: Server authentication only
;   2. TLS + strict        - OPTIONAL: Add verifyChain + checkHost  
;   3. mTLS (mutual)       - ADVANCED: Require client cert/key (explicit only)
;
; Usage:
;   psql -h localhost -p 15432 -U postgres -d postgres
;   postgresql://postgres:${POSTGRES_PASSWORD}@localhost:15432/postgres
;
; =============================================================================
foreground = yes

; -----------------------------------------------------------------------------
; MODE 1: TLS (One-way TLS - DEFAULT)
; -----------------------------------------------------------------------------
; Server authentication only. Trust is based on CA or system trust store.

[postgres-client]
client = yes

; Local listen port - Application connects here
accept = 127.0.0.1:15432

; Remote TLS endpoint (stunnel server)
connect = ${STUNNEL_HOST:-db.example.com}:${STUNNEL_PORT:-443}

; Server certificate verification
; verify = 2 ensures server certificate is checked against CA
verify = 2

; CA certificate path
; Optional: Rely on system trust store if server uses a public CA.
; Required: Provide CAfile if using a private or self-signed CA.
; CAfile = /path/to/ca-cert.pem

; TLS protocol configuration
sslVersion = TLSv1.2
options = NO_SSLv2
options = NO_SSLv3
options = NO_TLSv1

; Performance tuning
socket = l:TCP_NODELAY=1
socket = r:TCP_NODELAY=1
socket = l:SO_KEEPALIVE=1
socket = r:SO_KEEPALIVE=1

; Connection retry on failure
retry = yes

; Timeout settings (12 hours idle timeout for long database sessions)
TIMEOUTclose = 0
TIMEOUTidle = 43200

; -----------------------------------------------------------------------------
; MODE 2: TLS + Strict Hostname Verification (OPT-IN)
; -----------------------------------------------------------------------------
; Uncomment to enable extreme security (hostname & chain validation).
;
; verifyChain = yes
; checkHost = db.example.com

; -----------------------------------------------------------------------------
; MODE 3: mTLS - Mutual TLS (ADVANCED / OPT-IN ONLY)
; -----------------------------------------------------------------------------
; NEVER enabled by default. Only used if server enforces client certificates.
;
; cert = /path/to/client-cert.pem
; key  = /path/to/client-key.pem

; -----------------------------------------------------------------------------
; Logging (optional - uncomment for debugging)
; -----------------------------------------------------------------------------
; debug = 5
; output = /var/log/stunnel/stunnel-client.log
