name: Deploy to Kubernetes

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      cluster_type:
        description: 'Cluster type'
        required: true
        type: choice
        options:
          - k8s
          - k3s
      namespace:
        description: 'Kubernetes namespace'
        required: false
        default: 'postgresql'
      release_name:
        description: 'Helm release name'
        required: false
        default: 'postgresql'
      enable_stunnel:
        description: 'Enable Stunnel sidecar'
        required: false
        type: boolean
        default: true
      enable_metrics:
        description: 'Enable Prometheus metrics'
        required: false
        type: boolean
        default: false

env:
  HELM_VERSION: v3.13.0

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Create namespace
        run: |
          kubectl create namespace ${{ github.event.inputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Create secrets
        run: |
          # PostgreSQL password
          kubectl create secret generic postgresql-secret \
            --from-literal=password='${{ secrets.POSTGRES_PASSWORD }}' \
            --namespace=${{ github.event.inputs.namespace }} \
            --dry-run=client -o yaml | kubectl apply -f -
          
          # Stunnel certificates (if enabled)
          if [ "${{ github.event.inputs.enable_stunnel }}" == "true" ]; then
            if [ -n "${{ secrets.STUNNEL_CERT }}" ] && [ -n "${{ secrets.STUNNEL_KEY }}" ]; then
              kubectl create secret generic stunnel-certs \
                --from-literal=server-cert.pem='${{ secrets.STUNNEL_CERT }}' \
                --from-literal=server-key.pem='${{ secrets.STUNNEL_KEY }}' \
                --namespace=${{ github.event.inputs.namespace }} \
                --dry-run=client -o yaml | kubectl apply -f -
            fi
          fi

      - name: Create values file
        run: |
          cat > custom-values.yaml << EOF
          image:
            repository: ghcr.io/${{ github.repository }}/postgres-extensions
            tag: latest
            pullPolicy: Always

          auth:
            existingSecret: postgresql-secret
            secretKey: password
            username: postgres
            database: postgres

          persistence:
            enabled: true
            size: ${{ secrets.PVC_SIZE || '10Gi' }}
            storageClass: ${{ secrets.STORAGE_CLASS || '' }}

          resources:
            requests:
              memory: ${{ secrets.MEMORY_REQUEST || '1Gi' }}
              cpu: ${{ secrets.CPU_REQUEST || '500m' }}
            limits:
              memory: ${{ secrets.MEMORY_LIMIT || '2Gi' }}
              cpu: ${{ secrets.CPU_LIMIT || '2000m' }}

          stunnel:
            enabled: ${{ github.event.inputs.enable_stunnel }}
            port: 5433
            certificatesSecret: stunnel-certs

          metrics:
            enabled: ${{ github.event.inputs.enable_metrics }}
            service:
              annotations:
                prometheus.io/scrape: "true"
                prometheus.io/port: "9187"

          postgresql:
            config: |
              shared_buffers = 256MB
              effective_cache_size = 1GB
              work_mem = 16MB
              maintenance_work_mem = 64MB
              max_connections = 100
              wal_buffers = 16MB
              checkpoint_completion_target = 0.9
              random_page_cost = 1.1
              effective_io_concurrency = 200
              log_min_duration_statement = 1000

          initScripts:
            enabled: true
            scripts:
              01-init-extensions.sql: |
                CREATE EXTENSION IF NOT EXISTS vector;
                CREATE EXTENSION IF NOT EXISTS pg_jieba;
                CREATE EXTENSION IF NOT EXISTS pgmq;
                CREATE EXTENSION IF NOT EXISTS pg_trgm;
                CREATE EXTENSION IF NOT EXISTS hstore;
                CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
          EOF

      - name: Deploy with Helm
        run: |
          helm upgrade --install ${{ github.event.inputs.release_name }} \
            ./deploy/helm/postgresql \
            --namespace=${{ github.event.inputs.namespace }} \
            --values=custom-values.yaml \
            --wait \
            --timeout=10m

      - name: Verify deployment
        run: |
          echo "=== Pods ==="
          kubectl get pods -n ${{ github.event.inputs.namespace }} -l app.kubernetes.io/name=postgresql
          
          echo "=== Services ==="
          kubectl get svc -n ${{ github.event.inputs.namespace }} -l app.kubernetes.io/name=postgresql
          
          echo "=== PVC ==="
          kubectl get pvc -n ${{ github.event.inputs.namespace }}
          
          echo "=== Waiting for PostgreSQL to be ready ==="
          kubectl wait --for=condition=ready pod \
            -l app.kubernetes.io/name=postgresql \
            -n ${{ github.event.inputs.namespace }} \
            --timeout=300s

      - name: Test database connection
        run: |
          POD_NAME=$(kubectl get pods -n ${{ github.event.inputs.namespace }} \
            -l app.kubernetes.io/name=postgresql \
            -o jsonpath='{.items[0].metadata.name}')
          
          echo "=== Testing PostgreSQL ==="
          kubectl exec -n ${{ github.event.inputs.namespace }} $POD_NAME -- \
            pg_isready -U postgres
          
          echo "=== Checking extensions ==="
          kubectl exec -n ${{ github.event.inputs.namespace }} $POD_NAME -- \
            psql -U postgres -c "\dx"

      - name: Get connection info
        run: |
          echo "=== Connection Information ==="
          echo "Namespace: ${{ github.event.inputs.namespace }}"
          echo "Release: ${{ github.event.inputs.release_name }}"
          echo ""
          echo "Internal DNS:"
          echo "  postgresql.${{ github.event.inputs.namespace }}.svc.cluster.local:5432"
          
          if [ "${{ github.event.inputs.enable_stunnel }}" == "true" ]; then
            echo ""
            echo "Stunnel TLS endpoint:"
            echo "  postgresql.${{ github.event.inputs.namespace }}.svc.cluster.local:5433"
          fi
          
          echo ""
          echo "Port forward command:"
          echo "  kubectl port-forward -n ${{ github.event.inputs.namespace }} svc/postgresql 5432:5432"
          
          if [ "${{ github.event.inputs.enable_stunnel }}" == "true" ]; then
            echo "  kubectl port-forward -n ${{ github.event.inputs.namespace }} svc/postgresql 5433:5433"
          fi

      - name: Cleanup kubeconfig
        if: always()
        run: |
          rm -f ~/.kube/config
